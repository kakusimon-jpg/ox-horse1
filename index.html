<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>èµ›åšç‰›é©¬ä»»åŠ¡ç®¡ç†ç³»ç»Ÿ (Silicon Flowç‰ˆ)</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <!-- 1. å¼•å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. å¼•å…¥ Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- 3. ä¾èµ–åŒ…åœ°å›¾ -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom": "https://esm.sh/react-dom@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.263.1",
        "@supabase/supabase-js": "https://esm.sh/@supabase/supabase-js@2"
      }
    }
    </script>

    <style>
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 2px; }
        body { -webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; }
        .fade-in { animation: fadeIn 0.2s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.98); } to { opacity: 1; transform: scale(1); } }
        /* éšè—ç§»åŠ¨ç«¯æ»šåŠ¨æ¡ä½†ä¿ç•™æ»šåŠ¨åŠŸèƒ½ */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="bg-gradient-to-br from-indigo-50 via-purple-50 to-blue-50 min-h-screen text-slate-600 selection:bg-indigo-100 selection:text-indigo-700 pb-safe">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { createPortal } from 'react-dom';
        import { createClient } from '@supabase/supabase-js';
        
        import { 
          Trash2, Star, CheckCircle, Circle, Plus, Settings, X, 
          ChevronLeft, ChevronRight, Clock, 
          Brain, Sparkles, Loader2, Zap, 
          Upload, Search, Wifi, WifiOff, CloudOff,
          Download, Database, CheckSquare, Square, Key, AlertCircle, Globe, Cpu
        } from 'lucide-react';

        // -----------------------------------------------------------------------------
        // é…ç½®åŒºåŸŸ
        // -----------------------------------------------------------------------------
        const SUPABASE_URL = "https://iypgvyfsiygekbhkyldv.supabase.co";
        const SUPABASE_KEY = "sb_publishable_HqjmGbx9jfboFrSG-x45cQ_jumY9Lfp";
        const PUBLIC_APP_ID = 'cyber-ox-manager-public-v1';
        const LOCAL_STORAGE_KEY = 'cyber_ox_local_data_v1';

        const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

        // -----------------------------------------------------------------------------
        // Silicon Flow AI é€»è¾‘
        // -----------------------------------------------------------------------------
        const getApiKey = () => localStorage.getItem('silicon_api_key') || "";
        const getBaseUrl = () => {
            let url = localStorage.getItem('silicon_base_url') || "https://api.siliconflow.cn/v1";
            return url.replace(/\/$/, "");
        };
        const getModel = () => localStorage.getItem('silicon_model') || "deepseek-ai/DeepSeek-V3";

        const fetchWithRetry = async (url, options, retries = 3, delay = 1000) => {
          try {
            const response = await fetch(url, options);
            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(errorData?.error?.message || `HTTP error! status: ${response.status}`);
            }
            return await response.json();
          } catch (error) {
            if (retries > 0) {
              await new Promise(res => setTimeout(res, delay));
              return fetchWithRetry(url, options, retries - 1, delay * 2);
            }
            throw error;
          }
        };

        const callSiliconFlow = async (systemPrompt, userPrompt, jsonMode = false) => {
            const apiKey = getApiKey();
            const baseUrl = getBaseUrl();
            const model = getModel();
            if (!apiKey) throw new Error("è¯·å…ˆåœ¨è®¾ç½®ä¸­å¡«å†™ Silicon Flow API Key");
            const url = `${baseUrl}/chat/completions`;
            const payload = {
                model: model,
                messages: [
                    { role: "system", content: systemPrompt },
                    { role: "user", content: userPrompt }
                ],
                temperature: 0.7,
                stream: false
            };
            if (jsonMode) payload.response_format = { type: "json_object" };
            const result = await fetchWithRetry(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiKey}`
                },
                body: JSON.stringify(payload)
            });
            return result.choices?.[0]?.message?.content || "";
        };

        const callGeminiStrategyAnalysis = async (tasks, projects) => {
          const activeProjects = projects.filter(p => p.status === 'active');
          const pendingTasks = tasks.filter(t => t.status !== 'completed');
          const systemPrompt = `ä½ æ˜¯ä¸€ä½å¹½é»˜çš„â€œèµ›åšèŒåœºå¯¼å¸ˆâ€ã€‚åˆ†æç”¨æˆ·çš„ä»»åŠ¡å¹¶ç»™å‡ºæ¯’èˆŒä½†å®ç”¨çš„ç”Ÿå­˜å»ºè®®ã€‚è¯·ä¸¥æ ¼æŒ‰Markdownæ ¼å¼è¾“å‡ºï¼Œå¿…é¡»åŒ…å«ä»¥ä¸‹ç« èŠ‚ï¼š### ğŸ“Š æ¬ç –æ¦‚è§ˆ... ### ğŸš¨ é£é™©ç‚¹... ### ğŸš€ æ‘¸é±¼å»ºè®®... ### ğŸ§˜â€â™‚ï¸ å…»ç”Ÿç»...`;
          const userPrompt = `å½“å‰é¡¹ç›®ï¼š${activeProjects.map(p=>p.name).join(', ')}ã€‚æœªå®Œæˆä»»åŠ¡æ€»æ•°ï¼š${pendingTasks.length}ã€‚ä»»åŠ¡è¯¦æƒ…ï¼š${pendingTasks.slice(0, 10).map(t=>t.content).join('; ')}`;
          return await callSiliconFlow(systemPrompt, userPrompt);
        };

        const callGeminiTaskBreakdown = async (taskContent) => {
          const systemPrompt = `ä½ æ˜¯ä¸€ä¸ªé«˜æ•ˆçš„æ‰§è¡Œå®˜ã€‚è¯·å°†ç”¨æˆ·è¾“å…¥çš„ä»»åŠ¡æ‹†è§£ä¸º3-5ä¸ªå…·ä½“çš„å­æ­¥éª¤ã€‚è¯·ç›´æ¥è¿”å› JSON æ ¼å¼ï¼š{ "steps": ["æ­¥éª¤1", "æ­¥éª¤2"...] }ã€‚ä¸è¦æœ‰ä»»ä½•å¤šä½™çš„è§£é‡Šæ–‡å­—ã€‚`;
          const resultText = await callSiliconFlow(systemPrompt, `æ‹†è§£è¿™ä¸ªä»»åŠ¡ï¼š${taskContent}`, true);
          try { return JSON.parse(resultText).steps || []; } catch(e) { return []; }
        };

        const callGeminiProjectAudit = async (project, tasks) => {
          const systemPrompt = `ä½ æ˜¯ä¸€ä¸ªèµ„æ·±é¡¹ç›®ç»ç†ã€‚è¯·åˆ†æå½“å‰é¡¹ç›®ä»»åŠ¡ï¼Œæ‰¾å‡ºç¼ºå¤±çš„æ­¥éª¤å¹¶ç»™å‡ºä¼˜åŒ–å»ºè®®ã€‚è¿”å› JSON æ ¼å¼ï¼š{ "missingSteps": ["ä»»åŠ¡1", "ä»»åŠ¡2"], "advice": "å»ºè®®å†…å®¹" }`;
          const userPrompt = `é¡¹ç›®åç§°ï¼š${project.name}ã€‚å½“å‰å·²è§„åˆ’çš„ä»»åŠ¡ï¼š${tasks.map(t=>t.content).join('; ')}`;
          const resultText = await callSiliconFlow(systemPrompt, userPrompt, true);
          try { return JSON.parse(resultText); } catch(e) { return { missingSteps: [], advice: "åˆ†æå¤±è´¥" }; }
        };

        // -----------------------------------------------------------------------------
        // UI ç»„ä»¶
        // -----------------------------------------------------------------------------

        const formatDate = (dateStr) => {
          if (!dateStr) return '';
          const d = new Date(dateStr);
          return `${d.getMonth() + 1}/${d.getDate()} ${d.getHours()}:00`;
        };

        const getStartOfWeek = (date) => {
          const d = new Date(date);
          const day = d.getDay();
          const diff = d.getDate() - day + (day === 0 ? -6 : 1); 
          return new Date(d.setDate(diff));
        };

        const isSameDay = (d1, d2) => {
          return d1.getFullYear() === d2.getFullYear() &&
            d1.getMonth() === d2.getMonth() &&
            d1.getDate() === d2.getDate();
        };

        // è¡¥å……ç¼ºå¤±çš„ ListCheck ç»„ä»¶
        const ListCheck = ({size, className}) => (
          <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><path d="M15 2H9a1 1 0 0 0-1 1v2a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V3a1 1 0 0 0-1-1Z"/><path d="m9 14 2 2 4-4"/></svg>
        );

        // è¡¥å……ç¼ºå¤±çš„ ConfirmDialog ç»„ä»¶
        const ConfirmDialog = ({ isOpen, onClose, onConfirm, title, message }) => {
          if (!isOpen) return null;
          return (
            <div className="fixed inset-0 z-[9999] flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm animate-in fade-in duration-200">
              <div className="bg-white rounded-2xl shadow-2xl max-w-sm w-full p-6 animate-in zoom-in-95 duration-200 scale-100 border border-slate-100">
                <div className="flex items-center gap-3 mb-4 text-red-600">
                    <div className="p-2 bg-red-50 rounded-full"><AlertCircle size={24} /></div>
                    <h3 className="text-lg font-bold text-slate-800">{title}</h3>
                </div>
                <p className="text-sm text-slate-600 mb-6 leading-relaxed">{message}</p>
                <div className="flex justify-end gap-3">
                  <button onClick={onClose} className="px-4 py-2.5 bg-slate-100 text-slate-600 rounded-xl hover:bg-slate-200 font-bold text-sm transition-colors">å–æ¶ˆ</button>
                  <button onClick={onConfirm} className="px-4 py-2.5 bg-red-500 text-white rounded-xl hover:bg-red-600 font-bold text-sm shadow-md shadow-red-200 transition-colors">ç¡®è®¤åˆ é™¤</button>
                </div>
              </div>
            </div>
          );
        };

        // è¡¥å……ç¼ºå¤±çš„ AnalysisModal ç»„ä»¶
        const AnalysisModal = ({ isOpen, onClose, result, isAnalyzing }) => {
          if (!isOpen) return null;
          return (
            <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm">
              <div className="bg-white rounded-xl shadow-2xl max-w-2xl w-full flex flex-col max-h-[85vh] animate-in fade-in zoom-in duration-200">
                <div className="px-6 py-4 border-b border-gray-100 flex justify-between items-center bg-gradient-to-r from-violet-600 to-fuchsia-600 rounded-t-xl text-white">
                  <h3 className="text-lg font-bold flex items-center gap-2"><Brain size={20} /> å†›å¸ˆç”Ÿå­˜ç­–ç•¥æŠ¥å‘Š</h3>
                  <button onClick={onClose} className="hover:bg-white/20 p-1 rounded-full transition-colors"><X size={20} /></button>
                </div>
                <div className="flex-1 overflow-y-auto p-6">
                  {isAnalyzing ? (
                    <div className="flex flex-col items-center justify-center py-12 space-y-4"><Loader2 size={48} className="text-purple-600 animate-spin" /><h4 className="text-lg font-medium text-gray-800">æ­£åœ¨é€šè¿‡ Silicon Flow è¯·æ•™å¤§æ¨¡å‹...</h4></div>
                  ) : (
                    <div className="prose prose-sm md:prose-base max-w-none text-gray-700 space-y-4">
                      {result.split('\n').map((line, idx) => {
                        if (line.startsWith('### ')) return <h3 key={idx} className="text-lg font-bold text-gray-900 mt-4 mb-2 pb-1 border-b border-gray-100">{line.replace('### ', '')}</h3>;
                        if (line.startsWith('**') && line.endsWith('**')) return <strong key={idx} className="block mt-2 font-bold text-gray-800">{line.replace(/\*\*/g, '')}</strong>;
                        if (line.trim().startsWith('- ')) return <li key={idx} className="ml-4 list-disc marker:text-purple-500">{line.replace('- ', '')}</li>;
                        return <p key={idx} className="leading-relaxed">{line}</p>;
                      })}
                    </div>
                  )}
                </div>
                <div className="px-6 py-4 border-t border-gray-100 bg-gray-50 rounded-b-xl flex justify-end"><button onClick={onClose} className="px-4 py-2 bg-white border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 font-medium transition shadow-sm">å…³é—­æŠ¥å‘Š</button></div>
              </div>
            </div>
          );
        };

        // è¡¥å……ç¼ºå¤±çš„ ProjectAuditModal ç»„ä»¶
        const ProjectAuditModal = ({ isOpen, onClose, data, isAnalyzing, onAddTasks }) => {
          const [selectedTasks, setSelectedTasks] = useState([]);
          useEffect(() => { if (data?.missingSteps) setSelectedTasks(data.missingSteps); }, [data]);
          const toggleTask = (task) => setSelectedTasks(prev => prev.includes(task) ? prev.filter(t => t !== task) : [...prev, task]);
          if (!isOpen) return null;
          return (
            <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm">
              <div className="bg-white rounded-xl shadow-2xl max-w-2xl w-full flex flex-col max-h-[85vh] animate-in fade-in zoom-in duration-200">
                <div className="px-6 py-4 border-b border-gray-100 flex justify-between items-center bg-gradient-to-r from-blue-600 to-indigo-600 rounded-t-xl text-white">
                  <h3 className="text-lg font-bold flex items-center gap-2"><Search size={20} /> é¡¹ç›®æŸ¥æ¼è¡¥ç¼º (Silicon Flowç‰ˆ)</h3>
                  <button onClick={onClose} className="hover:bg-white/20 p-1 rounded-full transition-colors"><X size={20} /></button>
                </div>
                <div className="flex-1 overflow-y-auto p-6">
                  {isAnalyzing ? ( <div className="flex flex-col items-center justify-center py-12 space-y-4"><Loader2 size={48} className="text-blue-600 animate-spin" /><h4 className="text-lg font-medium text-gray-800">æ­£åœ¨åˆ†æé¡¹ç›®æµç¨‹...</h4></div> ) : (
                    <div className="space-y-6">
                      <div className="bg-blue-50 p-4 rounded-xl border border-blue-100"><h4 className="font-bold text-blue-900 mb-2 flex items-center gap-2"><Brain size={18}/> AI ä¼˜åŒ–å»ºè®®</h4><div className="prose prose-sm text-blue-800">{(data?.advice || "æš‚æ— å»ºè®®").split('\n').map((line, i) => <p key={i} className="mb-1">{line}</p>)}</div></div>
                      <div><h4 className="font-bold text-gray-800 mb-3 flex items-center gap-2"><ListCheck size={18} className="text-green-600"/> å»ºè®®è¡¥å……çš„ä»»åŠ¡</h4>{data?.missingSteps && data.missingSteps.length > 0 ? ( <div className="space-y-2">{data.missingSteps.map((task, idx) => ( <div key={idx} onClick={() => toggleTask(task)} className="flex items-center gap-3 p-3 rounded-lg border border-gray-200 hover:bg-gray-50 cursor-pointer transition-colors"><div className={selectedTasks.includes(task) ? "text-blue-600" : "text-gray-300"}>{selectedTasks.includes(task) ? <CheckSquare size={20} /> : <Square size={20} />}</div><span className="text-gray-700 text-sm font-medium">{task}</span></div> ))}</div> ) : <div className="text-center py-8 text-gray-500 bg-gray-50 rounded-lg border border-dashed border-gray-200">ğŸ‰ æµç¨‹éå¸¸å®Œå–„ï¼</div>}</div>
                    </div>
                  )}
                </div>
                {!isAnalyzing && ( <div className="px-6 py-4 border-t border-gray-100 bg-gray-50 rounded-b-xl flex justify-end gap-3"><button onClick={onClose} className="px-4 py-2 bg-white border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 font-medium transition shadow-sm">å…³é—­</button>{data?.missingSteps && data.missingSteps.length > 0 && ( <button onClick={() => onAddTasks(selectedTasks)} disabled={selectedTasks.length === 0} className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium transition shadow-sm disabled:opacity-50 flex items-center gap-2"><Plus size={18} /> ä¸€é”®è¡¥å…… {selectedTasks.length} ä¸ªä»»åŠ¡</button> )}</div> )}
              </div>
            </div>
          );
        };

        // è¡¥å……ç¼ºå¤±çš„ SettingsModal ç»„ä»¶
        const SettingsModal = ({ isOpen, onClose, onExport, onImport, isProcessing, isOffline, onSyncToCloud }) => {
          const fileInputRef = useRef(null);
          const [userKey, setUserKey] = useState(localStorage.getItem('silicon_api_key') || '');
          const [baseUrl, setBaseUrl] = useState(localStorage.getItem('silicon_base_url') || 'https://api.siliconflow.cn/v1');
          const [selectedModel, setSelectedModel] = useState(localStorage.getItem('silicon_model') || 'deepseek-ai/DeepSeek-V3');
          
          if (!isOpen) return null;
          
          const handleSaveSettings = () => { 
            localStorage.setItem('silicon_api_key', userKey.trim());
            localStorage.setItem('silicon_base_url', baseUrl.trim());
            localStorage.setItem('silicon_model', selectedModel.trim());
            alert("Silicon Flow é…ç½®å·²ä¿å­˜"); 
          };
          const handleFileChange = (e) => { const file = e.target.files[0]; if (file) onImport(file); e.target.value = null; };

          const modelOptions = [
            { label: 'DeepSeek-V3', value: 'deepseek-ai/DeepSeek-V3' },
            { label: 'DeepSeek-R1', value: 'deepseek-ai/DeepSeek-R1' },
            { label: 'DeepSeek-V2.5', value: 'deepseek-ai/DeepSeek-V2.5' },
            { label: 'Qwen 2.5 72B', value: 'Qwen/Qwen2.5-72B-Instruct' },
            { label: 'Llama 3.1 70B', value: 'meta-llama/Meta-Llama-3.1-70B-Instruct' }
          ];

          return (
            <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm">
              <div className="bg-white rounded-xl shadow-2xl max-w-lg w-full p-6 animate-in fade-in zoom-in duration-200 max-h-[90vh] overflow-y-auto">
                <div className="flex justify-between items-center mb-6 border-b border-gray-100 pb-4"><h3 className="text-xl font-bold text-gray-900 flex items-center gap-2"><Settings size={24} className="text-gray-500" /> ç³»ç»Ÿè®¾ç½®</h3><button onClick={onClose} className="text-gray-400 hover:text-gray-600"><X size={24} /></button></div>
                <div className="space-y-6">
                  {isOffline && (
                    <div className="bg-amber-50 p-4 rounded-lg border border-amber-100">
                        <h4 className="font-bold text-amber-900 mb-2 flex items-center gap-2"><CloudOff size={18} /> ç¦»çº¿çŠ¶æ€</h4>
                        <button onClick={onSyncToCloud} disabled={isProcessing} className="w-full py-2 bg-amber-500 text-white rounded-lg hover:bg-amber-600 transition flex items-center justify-center gap-2 font-medium shadow-sm">{isProcessing ? <Loader2 className="animate-spin" size={18}/> : <Upload size={18}/>} åŒæ­¥æœ¬åœ°æ•°æ®åˆ°äº‘ç«¯</button>
                    </div>
                  )}

                  <div className="bg-violet-50 p-4 rounded-lg border border-violet-100">
                    <h4 className="font-bold text-violet-900 mb-3 flex items-center gap-2"><Cpu size={18} /> Silicon Flow AI é…ç½®</h4>
                    <div className="space-y-4">
                        <div>
                            <label className="text-xs font-bold text-violet-800 mb-1 block">API Key</label>
                            <input type="password" value={userKey} onChange={(e) => setUserKey(e.target.value)} placeholder="sk-..." className="w-full px-3 py-2 border border-violet-200 rounded text-sm focus:ring-2 focus:ring-violet-300 outline-none" />
                        </div>
                        <div>
                            <label className="text-xs font-bold text-violet-800 mb-1 block">API åœ°å€</label>
                            <input type="text" value={baseUrl} onChange={(e) => setBaseUrl(e.target.value)} className="w-full px-3 py-2 border border-violet-200 rounded text-sm focus:ring-2 focus:ring-violet-300 outline-none" />
                        </div>
                        <div>
                            <label className="text-xs font-bold text-violet-800 mb-1 block">æ¨¡å‹é€‰æ‹©</label>
                            <select value={selectedModel} onChange={(e) => setSelectedModel(e.target.value)} className="w-full px-3 py-2 border border-violet-200 rounded text-sm focus:ring-2 focus:ring-violet-300 outline-none bg-white">
                                {modelOptions.map(opt => <option key={opt.value} value={opt.value}>{opt.label}</option>)}
                                <option value="custom">è‡ªå®šä¹‰æ¨¡å‹ ID...</option>
                            </select>
                            {selectedModel === 'custom' && (
                                <input type="text" placeholder="è¾“å…¥æ¨¡å‹å®Œæ•´ ID" onBlur={(e) => setSelectedModel(e.target.value)} className="mt-2 w-full px-3 py-2 border border-violet-200 rounded text-sm focus:ring-2 focus:ring-violet-300 outline-none" />
                            )}
                        </div>
                        <button onClick={handleSaveSettings} className="w-full py-2 bg-violet-600 text-white rounded-lg font-bold hover:bg-violet-700 transition shadow-sm">ä¿å­˜ AI é…ç½®</button>
                    </div>
                  </div>

                  <div className="grid grid-cols-2 gap-3">
                    <button onClick={onExport} disabled={isProcessing} className="py-2 bg-blue-50 text-blue-600 border border-blue-200 rounded-lg hover:bg-blue-100 transition flex items-center justify-center gap-2 text-sm font-bold"><Download size={16} /> å¯¼å‡ºå¤‡ä»½</button>
                    <button onClick={() => fileInputRef.current?.click()} disabled={isProcessing} className="py-2 bg-orange-50 text-orange-600 border border-orange-200 rounded-lg hover:bg-orange-100 transition flex items-center justify-center gap-2 text-sm font-bold"><Upload size={16} /> å¯¼å…¥æ¢å¤</button>
                    <input type="file" ref={fileInputRef} accept=".json" onChange={handleFileChange} className="hidden" />
                  </div>
                </div>
              </div>
            </div>
          );
        };

        // å±…ä¸­çš„æ—¥æœŸé€‰æ‹©å™¨ - ä½¿ç”¨ Portal
        const CustomDatePicker = ({ isOpen, onClose, onSelect, initialDate }) => {
          const [currentMonth, setCurrentMonth] = useState(new Date());
          const [selectedDay, setSelectedDay] = useState(new Date().getDate());
          const popupRef = useRef();

          useEffect(() => {
            if (isOpen) {
              const d = initialDate ? new Date(initialDate) : new Date();
              setCurrentMonth(d);
              setSelectedDay(d.getDate());
            }
          }, [isOpen, initialDate]);

          if (!isOpen) return null;

          const daysInMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1, 0).getDate();
          const firstDay = new Date(currentMonth.getFullYear(), currentMonth.getMonth(), 1).getDay();

          return createPortal(
            <div 
              className="fixed inset-0 z-[999] flex items-center justify-center bg-black/50 backdrop-blur-sm p-4 animate-in fade-in duration-200"
              onClick={onClose}
            >
              <div 
                ref={popupRef} 
                className="bg-white shadow-2xl rounded-2xl border border-slate-100 p-6 w-full max-w-sm flex flex-col gap-5 animate-in zoom-in-95 duration-200"
                onClick={e => e.stopPropagation()}
              >
                <div className="flex justify-between items-center font-bold text-slate-800 border-b pb-3">
                  <button onClick={() => setCurrentMonth(new Date(currentMonth.setMonth(currentMonth.getMonth()-1)))} className="p-2 hover:bg-slate-100 rounded-lg transition-colors"><ChevronLeft size={20}/></button>
                  <span className="text-lg">{currentMonth.getFullYear()}å¹´ {currentMonth.getMonth() + 1}æœˆ</span>
                  <button onClick={() => setCurrentMonth(new Date(currentMonth.setMonth(currentMonth.getMonth()+1)))} className="p-2 hover:bg-slate-100 rounded-lg transition-colors"><ChevronRight size={20}/></button>
                </div>

                <div className="grid grid-cols-7 gap-1 text-center text-sm mb-2">
                  {['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'].map(d=><div key={d} className="text-slate-400 font-medium py-1">{d}</div>)}
                  {Array.from({length: firstDay}).map((_,i)=><div key={'e'+i}/>)}
                  {Array.from({length: daysInMonth}).map((_,i)=>{
                    const d=i+1;
                    const isToday = isSameDay(new Date(), new Date(currentMonth.getFullYear(), currentMonth.getMonth(), d));
                    return (
                      <button 
                        key={d} 
                        onClick={()=>setSelectedDay(d)} 
                        className={`w-10 h-10 rounded-xl flex items-center justify-center transition-all ${d===selectedDay?'bg-indigo-600 text-white shadow-lg shadow-indigo-200':'hover:bg-indigo-50 text-slate-700'} ${isToday && d !== selectedDay ? 'text-indigo-600 font-bold' : ''}`}
                      >
                        {d}
                      </button>
                    );
                  })}
                </div>

                <div className="pt-4 border-t border-slate-100">
                  <p className="text-xs font-bold text-slate-400 mb-3 ml-1 uppercase tracking-wider">é€‰æ‹©å…·ä½“æ—¶é—´ç‚¹</p>
                  <div className="grid grid-cols-4 gap-2">
                    {[9,12,15,18,21].map(h=><button key={h} onClick={()=>{const d=new Date(currentMonth); d.setDate(selectedDay); d.setHours(h); d.setMinutes(0); onSelect(d.toISOString()); onClose();}} className="text-xs py-2.5 font-bold bg-slate-50 hover:bg-indigo-600 hover:text-white text-indigo-600 rounded-xl transition-all">{h}:00</button>)}
                  </div>
                </div>

                <button onClick={onClose} className="mt-2 w-full py-3 bg-slate-100 text-slate-500 rounded-xl font-bold hover:bg-slate-200 transition-colors">å–æ¶ˆ</button>
              </div>
            </div>,
            document.body
          );
        };

        const TaskItem = ({ task, project, assigners = [], onUpdate, onDeleteRequest, onViewProject, onSmartBreakdown, breakdownLoadingId }) => {
           const [showDatePicker, setShowDatePicker] = useState(false);
           const isOverdue = task.plan_date && new Date(task.plan_date) < new Date() && task.status !== 'completed';
           const isBreakingDown = breakdownLoadingId === task.id;
           let bgClass = "bg-white border-slate-200";
           if(task.status==='completed') bgClass="opacity-60 bg-slate-50"; else if(task.is_important) bgClass="bg-yellow-50 border-yellow-200"; else if(isOverdue) bgClass="bg-green-50 border-green-200";
           return (
             <div className={`flex items-center gap-2 p-3 rounded-lg border hover:shadow-sm transition-all ${bgClass} group fade-in`}>
                <button onClick={()=>onUpdate(task.id, {status:task.status==='completed'?'active':'completed', completed_at: new Date().toISOString()})} className={task.status==='completed'?'text-slate-400':'text-slate-300 hover:text-indigo-500'}>{task.status==='completed'?<CheckCircle size={18}/>:<Circle size={18}/>}</button>
                <div className="flex-1 min-w-0">
                    <textarea rows={1} className={`bg-transparent w-full outline-none resize-none overflow-hidden line-clamp-2 whitespace-normal ${task.status==='completed'?'line-through text-slate-400':'text-slate-700'}`} defaultValue={task.content} onBlur={(e)=>onUpdate(task.id,{content:e.target.value})} onInput={(e) => {e.target.style.height = 'auto';e.target.style.height = (e.target.scrollHeight) + 'px';}}/>
                    {project && <div onClick={onViewProject} className="text-[10px] text-slate-400 hover:text-indigo-500 cursor-pointer">#{project.name}</div>}
                </div>
                <div onClick={() => setShowDatePicker(true)} className="flex-shrink-0 w-24 text-right text-xs text-slate-500 cursor-pointer hover:text-indigo-600 flex items-center justify-end gap-1"><Clock size={12} className={isOverdue ? "text-green-500" : ""} />{task.plan_date ? formatDate(task.plan_date).split(' ')[0] + ' ' + formatDate(task.plan_date).split(' ')[1] : 'è®¡åˆ’æ—¶é—´'}</div>
                {task.status !== 'completed' && (<button onClick={() => onSmartBreakdown(task)} disabled={isBreakingDown} className={`text-slate-300 hover:text-violet-500 p-1 rounded hover:bg-violet-50 transition-all ${isBreakingDown ? 'animate-pulse text-violet-500' : 'opacity-0 group-hover:opacity-100'}`} title="AI æ™ºèƒ½æ‹†è§£">{isBreakingDown ? <Loader2 size={16} className="animate-spin"/> : <Zap size={16}/>}</button>)}
                <button onClick={()=>onUpdate(task.id,{is_important:!task.is_important})} className="text-slate-300 hover:scale-110">{<Star size={16} className={task.is_important?"fill-yellow-400 text-yellow-400":""}/>}</button>
                <button onClick={(e) => { e.stopPropagation(); onDeleteRequest(task.id); }} className="text-slate-300 hover:text-red-500 opacity-0 group-hover:opacity-100 hover:scale-110 transition-transform"><Trash2 size={16}/></button>
                <CustomDatePicker isOpen={showDatePicker} onClose={() => setShowDatePicker(false)} onSelect={(date) => onUpdate(task.id, { plan_date: date })} initialDate={task.plan_date} />
             </div>
           );
        };

        const ProjectCard = ({ project, onClick, onDeleteRequest, onUpdate, onComplete }) => (
           <div className={`p-4 rounded-xl border shadow-sm hover:shadow-md transition-all bg-white relative group fade-in ${project.wait_status==='wait_me'?'border-yellow-200 bg-yellow-50':''}`}><div className="flex justify-between mb-2"><h3 onClick={onClick} className="font-bold text-slate-700 cursor-pointer hover:text-indigo-600">{project.name}</h3><button onClick={onComplete} className="text-slate-300 hover:text-indigo-500"><Circle size={16}/></button></div><p className="text-xs text-slate-400 h-8 line-clamp-2">{project.note||'æ— å¤‡æ³¨'}</p><div className="flex justify-between items-center mt-3 pt-2 border-t border-slate-100"><span className="text-[10px] text-slate-300">{formatDate(project.created_at).split(' ')[0]}</span><div className="flex gap-2"><select className="text-[10px] bg-transparent outline-none cursor-pointer text-slate-500" value={project.wait_status||'normal'} onChange={(e)=>onUpdate(project.id,{wait_status:e.target.value})} onClick={e=>e.stopPropagation()}><option value="normal">è¿›è¡Œä¸­</option><option value="wait_me">âœ‹ ç­‰æˆ‘</option><option value="wait_him">ğŸ‘‰ ç­‰ä»–</option></select><button onClick={(e)=>{e.stopPropagation(); onDeleteRequest(project.id)}} className="text-slate-200 hover:text-red-400 opacity-0 group-hover:opacity-100 hover:scale-110 transition-transform"><Trash2 size={14}/></button></div></div></div>
        );

        const MainTab = ({ tasks, projects, assigners, onUpdateTask, onDeleteTaskRequest, onViewProject, onCreateProject, onDeleteProjectRequest, onUpdateProject, onSmartBreakdown, breakdownLoadingId }) => {
           const activeProjects = projects.filter(p=>p.status==='active');
           const importantTasks = tasks.filter(t=>t.status!=='completed' && t.is_important);
           const overdueTasks = tasks.filter(t => t.status !== 'completed' && !t.is_important && t.plan_date && new Date(t.plan_date) < new Date());
           return (
             <div className="space-y-8 animate-in"><div className="grid grid-cols-1 md:grid-cols-2 gap-6"><section className="bg-white/50 p-4 rounded-xl border border-yellow-100 backdrop-blur-sm"><h3 className="flex items-center gap-2 text-lg font-bold text-slate-800 mb-3"><Star className="fill-yellow-400 text-yellow-400" size={20}/> é‡è¦èŠ‚ç‚¹</h3><div className="space-y-2">{importantTasks.length > 0 ? importantTasks.map(t=>(<TaskItem key={t.id} task={t} project={projects.find(p=>p.id===t.project_id)} assigners={assigners} onUpdate={onUpdateTask} onDeleteRequest={onDeleteTaskRequest} onViewProject={()=>onViewProject(t.project_id)} onSmartBreakdown={onSmartBreakdown} breakdownLoadingId={breakdownLoadingId}/>)) : <div className="text-slate-400 text-sm text-center py-4">æš‚æ— é‡è¦å¾…åŠ</div>}</div></section><section className="bg-white/50 p-4 rounded-xl border border-green-100 backdrop-blur-sm"><h3 className="flex items-center gap-2 text-lg font-bold text-slate-800 mb-3"><Clock className="text-green-500" size={20}/> é€¾æœŸèŠ‚ç‚¹</h3><div className="space-y-2">{overdueTasks.length > 0 ? overdueTasks.map(t=>(<TaskItem key={t.id} task={t} project={projects.find(p=>p.id===t.project_id)} assigners={assigners} onUpdate={onUpdateTask} onDeleteRequest={onDeleteTaskRequest} onViewProject={()=>onViewProject(t.project_id)} onSmartBreakdown={onSmartBreakdown} breakdownLoadingId={breakdownLoadingId}/>)) : <div className="text-slate-400 text-sm text-center py-4">æ— é€¾æœŸä»»åŠ¡</div>}</div></section></div><section><h3 className="text-lg font-bold text-slate-800 mb-3">é¡¹ç›®çœ‹æ¿</h3><div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">{activeProjects.map(p=><ProjectCard key={p.id} project={p} onClick={()=>onViewProject(p.id)} onDeleteRequest={onDeleteProjectRequest} onUpdate={onUpdateProject} onComplete={()=>onUpdateProject(p.id,{status:'completed'})} />)}<button onClick={onCreateProject} className="border-2 border-dashed border-slate-300 bg-white/30 rounded-xl h-32 flex flex-col items-center justify-center text-slate-500 hover:border-indigo-400 hover:text-indigo-600 hover:bg-indigo-50/50 transition-all"><Plus size={24}/><span className="text-xs mt-1">æ–°é¡¹ç›®</span></button></div></section></div>
           );
        };

        const HistoryTab = ({ tasks, projects, assigners, onUpdateTask, onDeleteTaskRequest, onViewProject }) => {
          const completedTasks = tasks.filter(t => t.status === 'completed');
          const grouped = {};
          completedTasks.forEach(t => { if(!t.completed_at) return; const dateKey = new Date(t.completed_at).toLocaleDateString(); if (!grouped[dateKey]) grouped[dateKey] = []; grouped[dateKey].push(t); });
          const sortedDates = Object.keys(grouped).sort((a,b) => new Date(b) - new Date(a));
          return (<div className="space-y-6 animate-in"><h2 className="text-xl font-bold text-slate-800">å·²æ‰§è¡ŒèŠ‚ç‚¹</h2>{sortedDates.map(date => (<div key={date}><div className="flex items-center gap-4 mb-2"><span className="bg-white/80 text-slate-600 px-3 py-1 rounded-full text-xs font-bold border border-slate-100 shadow-sm">{date}</span><div className="h-px bg-slate-200 flex-1"></div></div><div className="space-y-1 pl-4">{grouped[date].map(task => (<TaskItem key={task.id} task={task} project={projects.find(p=>p.id===task.project_id)} assigners={assigners} onUpdate={onUpdateTask} onDeleteRequest={onDeleteTaskRequest} onViewProject={() => onViewProject(task.project_id)} onSmartBreakdown={()=>{}}/>))}</div></div>))}{completedTasks.length === 0 && <div className="text-center text-slate-400 mt-20">è¿˜æ²¡æœ‰å®Œæˆä»»ä½•ä»»åŠ¡</div>}</div>);
        };

        const CompletedProjectsTab = ({ projects, onViewProject, onDeleteProjectRequest, onUpdateProject }) => {
          const completedProjects = projects.filter(p => p.status === 'completed');
          return (<div className="space-y-6 animate-in"><h2 className="text-xl font-bold text-slate-800">å®Œå·¥é¡¹ç›®</h2><div className="grid grid-cols-1 md:grid-cols-3 gap-4">{completedProjects.map(p => (<ProjectCard key={p.id} project={p} onClick={()=>onViewProject(p.id)} onDeleteRequest={onDeleteProjectRequest} onUpdate={onUpdateProject} onComplete={()=>onUpdateProject(p.id,{status:'active'})} />))}</div>{completedProjects.length === 0 && <div className="text-center text-slate-400 mt-20">è¿˜æ²¡æœ‰å®Œå·¥çš„é¡¹ç›®</div>}</div>);
        };

        const WeeklyReportTab = ({ tasks, projects, onUpdateTask }) => {
          const [currentWeekStart, setCurrentWeekStart] = useState(() => getStartOfWeek(new Date()));
          const changeWeek = (weeks) => { const newDate = new Date(currentWeekStart); newDate.setDate(newDate.getDate() + (weeks * 7)); setCurrentWeekStart(newDate); };
          const weekDays = useMemo(() => Array.from({length: 5}, (_, i) => { const d = new Date(currentWeekStart); d.setDate(d.getDate() + i); return d; }), [currentWeekStart]);
          const dateRangeStr = `${weekDays[0].getFullYear()}å¹´${weekDays[0].getMonth()+1}æœˆ${weekDays[0].getDate()}æ—¥ - ${weekDays[4].getMonth()+1}æœˆ${weekDays[4].getDate()}æ—¥`;
          return (<div className="bg-white/80 backdrop-blur-md rounded-xl shadow-sm border border-slate-100 overflow-hidden animate-in h-[calc(100vh-200px)] flex flex-col"><div className="p-4 border-b border-slate-100 flex justify-between items-center bg-slate-50/50 flex-shrink-0"><div className="flex items-center gap-2"><button onClick={() => changeWeek(-1)} className="p-1 hover:bg-white rounded-lg"><ChevronLeft size={20}/></button><span className="text-sm font-bold text-slate-700 w-48 text-center">{dateRangeStr}</span><button onClick={() => changeWeek(1)} className="p-1 hover:bg-white rounded-lg"><ChevronRight size={20}/></button></div><button onClick={() => setCurrentWeekStart(getStartOfWeek(new Date()))} className="text-xs text-indigo-600 font-medium px-3 py-1 bg-indigo-50 rounded-full">å›åˆ°æœ¬å‘¨</button></div><div className="grid grid-cols-5 bg-slate-50/30 border-b border-slate-100 divide-x divide-slate-100 flex-shrink-0">{weekDays.map(d => (<div key={d.toISOString()} className="p-4 text-center"><div className="text-sm font-bold text-slate-700">{['å‘¨ä¸€','å‘¨äºŒ','å‘¨ä¸‰','å‘¨å››','å‘¨äº”'][d.getDay()-1]}</div><div className="text-xs text-slate-400">{d.getMonth()+1}/{d.getDate()}</div></div>))}</div><div className="grid grid-cols-5 divide-x divide-slate-100 flex-1 overflow-y-auto">{weekDays.map(day => { const dayTasks = tasks.filter(t => t.plan_date && isSameDay(new Date(t.plan_date), day)); return (<div key={day.toISOString()} className="p-2 space-y-2 min-h-full">{dayTasks.map(t => { const proj = projects.find(p => p.id === t.project_id); return (<div key={t.id} className="bg-indigo-50/50 p-2 rounded border border-indigo-100/50 text-xs hover:bg-indigo-100 transition-colors cursor-pointer" onClick={() => onUpdateTask(t.id, { status: t.status === 'completed' ? 'active' : 'completed', completed_at: t.status === 'completed' ? null : new Date().toISOString() })}><div className="flex items-start gap-1"><div className={`mt-0.5 w-2 h-2 rounded-full ${t.status === 'completed' ? 'bg-indigo-400' : 'border border-indigo-400'}`}></div><span className={t.status === 'completed' ? 'line-through opacity-50' : ''}>{t.content}</span></div>{proj && <div className="text-[10px] text-slate-400 text-right mt-1">#{proj.name}</div>}</div>)})}</div>)})}</div></div>);
        };

        const QuickCreateModal = ({ isOpen, onClose, projects, assigners, onCreate }) => {
           const [content, setC] = useState(''); const [pid, setP] = useState('');
           if(!isOpen) return null;
           return (<div className="fixed inset-0 bg-black/30 z-[1000] flex items-center justify-center p-4 backdrop-blur-sm"><div className="bg-white rounded-2xl p-6 w-full max-w-md shadow-2xl animate-in zoom-in-95"><h3 className="font-bold text-lg mb-4">å¿«é€Ÿåˆ›å»º</h3><form onSubmit={(e)=>{e.preventDefault(); if(content){onCreate({content, project_id:pid, assigner:'', plan_date:new Date().toISOString(), is_important:false}); setC(''); onClose();}}}><input name="c" className="w-full border border-slate-200 rounded-lg p-3 mb-4 outline-none focus:border-indigo-500" autoFocus placeholder="åšä»€ä¹ˆ?" value={content} onChange={e=>setC(e.target.value)}/><select name="p" className="w-full border border-slate-200 rounded-lg p-3 mb-6 bg-white" value={pid} onChange={e=>setP(e.target.value)}><option value="">æ‚é¡¹ (æ— é¡¹ç›®)</option>{projects.filter(p=>p.status==='active').map(p=><option key={p.id} value={p.id}>{p.name}</option>)}</select><button type="submit" className="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold shadow-lg shadow-indigo-200">åˆ›å»º</button><button type="button" onClick={onClose} className="w-full mt-2 text-slate-400 py-2">å–æ¶ˆ</button></form></div></div>)
        };

        function App() {
          const [projects, setProjects] = useState([]);
          const [tasks, setTasks] = useState([]);
          const [isOffline, setIsOffline] = useState(false); 
          const [currentTab, setCurrentTab] = useState('main'); 
          const [editingProjectId, setEditingProjectId] = useState(null); 
          const [showQuickCreate, setShowQuickCreate] = useState(false);
          const [showSettings, setShowSettings] = useState(false);
          const [isProcessingData, setIsProcessingData] = useState(false);
          const [projectTaskInput, setProjectTaskInput] = useState('');
          const [showAIModal, setShowAIModal] = useState(false);
          const [analysisResult, setAnalysisResult] = useState('');
          const [isAnalyzing, setIsAnalyzing] = useState(false);
          const [showAuditModal, setShowAuditModal] = useState(false);
          const [auditResult, setAuditResult] = useState(null);
          const [auditLoading, setAuditLoading] = useState(false);
          const [breakdownLoadingId, setBreakdownLoadingId] = useState(null);
          const [confirmData, setConfirmData] = useState({ isOpen: false, id: null, type: null, title: '', msg: '' });
          const assigners = useMemo(() => [...new Set(tasks.map(t => t.assigner).filter(Boolean))], [tasks]);

          useEffect(() => {
            const initData = async () => {
              try {
                const pPromise = supabase.from('projects').select('*').eq('app_id', PUBLIC_APP_ID).order('created_at', { ascending: false });
                const tPromise = supabase.from('tasks').select('*').eq('app_id', PUBLIC_APP_ID).order('created_at', { ascending: false });
                const [pRes, tRes] = await Promise.race([
                    Promise.all([pPromise, tPromise]),
                    new Promise((_, reject) => setTimeout(() => reject(new Error('timeout')), 3000))
                ]);
                if (pRes.error) throw pRes.error;
                if (tRes.error) throw tRes.error;
                setProjects(pRes.data);
                setTasks(tRes.data);
                const channel = supabase.channel('cyber_ox_realtime')
                  .on('postgres_changes', { event: '*', schema: 'public', table: 'projects', filter: `app_id=eq.${PUBLIC_APP_ID}` }, (payload) => {
                      if (payload.eventType === 'INSERT') setProjects(prev => [payload.new, ...prev]);
                      if (payload.eventType === 'UPDATE') setProjects(prev => prev.map(p => p.id === payload.new.id ? payload.new : p));
                      if (payload.eventType === 'DELETE') setProjects(prev => prev.filter(p => p.id !== payload.old.id));
                  })
                  .on('postgres_changes', { event: '*', schema: 'public', table: 'tasks', filter: `app_id=eq.${PUBLIC_APP_ID}` }, (payload) => {
                      if (payload.eventType === 'INSERT') setTasks(prev => [payload.new, ...prev]);
                      if (payload.eventType === 'UPDATE') setTasks(prev => prev.map(t => t.id === payload.new.id ? payload.new : t));
                      if (payload.eventType === 'DELETE') setTasks(prev => prev.filter(t => t.id !== payload.old.id));
                  })
                  .subscribe();
                return () => supabase.removeChannel(channel);
              } catch (err) {
                console.warn("Supabase connect failed, switching to Local Mode:", err);
                setIsOffline(true);
                const localData = JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEY) || '{"projects":[], "tasks":[]}');
                setProjects(localData.projects);
                setTasks(localData.tasks);
              }
            };
            initData();
          }, []);

          useEffect(() => {
            if (isOffline) {
                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify({ projects, tasks }));
            }
          }, [projects, tasks, isOffline]);

          const handleCreateTask = async(d) => { 
            const newTask = { ...d, id: crypto.randomUUID(), app_id: PUBLIC_APP_ID, status:'active', created_at: new Date().toISOString() };
            if (isOffline) setTasks(prev => [newTask, ...prev]);
            else await supabase.from('tasks').insert(newTask); 
          };

          const handleUpdateTask = async(id, d) => {
            if (isOffline) setTasks(prev => prev.map(t => t.id === id ? { ...t, ...d } : t));
            else await supabase.from('tasks').update(d).eq('id', id);
          };

          const handleCreateProject = async () => { 
            const newProject = { 
                id: crypto.randomUUID(), name: 'æ–°é¡¹ç›® '+new Date().toLocaleDateString(), status:'active', wait_status:'normal', app_id: PUBLIC_APP_ID, created_at: new Date().toISOString()
            };
            if (isOffline) { setProjects(prev => [newProject, ...prev]); setEditingProjectId(newProject.id); }
            else { const { data } = await supabase.from('projects').insert(newProject).select().single(); if (data) setEditingProjectId(data.id); }
          };

          const handleUpdateProject = async(id, d) => {
            if (isOffline) setProjects(prev => prev.map(p => p.id === id ? { ...p, ...d } : p));
            else await supabase.from('projects').update(d).eq('id', id);
          };

          const requestDeleteTask = (id) => {
            setConfirmData({ isOpen: true, id, type: 'task', title: 'åˆ é™¤ä»»åŠ¡', msg: 'ç¡®è®¤åˆ é™¤è¿™ä¸ªä»»åŠ¡å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ã€‚' });
          };

          const requestDeleteProject = (id) => {
            setConfirmData({ isOpen: true, id, type: 'project', title: 'åˆ é™¤é¡¹ç›®', msg: 'è­¦å‘Šï¼šåˆ é™¤é¡¹ç›®å°†åŒæ—¶åˆ é™¤è¯¥é¡¹ç›®ä¸‹çš„æ‰€æœ‰ä»»åŠ¡ï¼æ­¤æ“ä½œæ— æ³•æ’¤é”€ã€‚' });
          };

          const executeDelete = async () => {
            const { type, id } = confirmData;
            if (!type || !id) return;
            setConfirmData({ isOpen: false, id: null, type: null, title: '', msg: '' });
            try {
                if (type === 'task') { setTasks(prev => prev.filter(t => t.id !== id)); if (!isOffline) await supabase.from('tasks').delete().eq('id', id); }
                else if (type === 'project') {
                    setProjects(prev => prev.filter(p => p.id !== id));
                    setTasks(prev => prev.filter(t => t.project_id !== id)); 
                    if(editingProjectId===id) setEditingProjectId(null); 
                    if (!isOffline) { await supabase.from('tasks').delete().eq('project_id', id); await supabase.from('projects').delete().eq('id', id); }
                }
            } catch (err) { alert("åˆ é™¤å‡ºé”™ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•"); }
          };

          const handleSyncToCloud = async () => {
             if (!confirm("ç¡®å®šè¦å°è¯•è¿æ¥äº‘ç«¯å—ï¼Ÿ")) return;
             setIsProcessingData(true);
             try {
                 const { error: pErr } = await supabase.from('projects').upsert(projects); if (pErr) throw pErr;
                 const { error: tErr } = await supabase.from('tasks').upsert(tasks); if (tErr) throw tErr;
                 alert("åŒæ­¥æˆåŠŸï¼"); localStorage.removeItem(LOCAL_STORAGE_KEY); window.location.reload();
             } catch (e) { alert("åŒæ­¥å¤±è´¥: " + e.message); } finally { setIsProcessingData(false); }
          };

          const handleRunAdvisor = async () => {
             setIsAnalyzing(true); setShowAIModal(true); setAnalysisResult('');
             try { const result = await callGeminiStrategyAnalysis(tasks, projects); setAnalysisResult(result); } catch (err) { alert(err.message); setShowAIModal(false); } finally { setIsAnalyzing(false); }
          };

          const handleSmartBreakdown = async (task) => {
             setBreakdownLoadingId(task.id);
             try {
                const steps = await callGeminiTaskBreakdown(task.content);
                if (steps && steps.length > 0) { 
                  const newTasks = steps.map(stepText => ({ id: crypto.randomUUID(), content: stepText, project_id: task.project_id || '', assigner: task.assigner || '', plan_date: task.plan_date || '', is_important: false, status: 'active', app_id: PUBLIC_APP_ID, created_at: new Date().toISOString() }));
                  if (isOffline) setTasks(prev => [...newTasks, ...prev]);
                  else await supabase.from('tasks').insert(newTasks);
                }
             } catch (err) { alert(`æ‹†è§£å¤±è´¥: ${err.message}`); } finally { setBreakdownLoadingId(null); }
          };

          const handleProjectAudit = async () => {
            if (!editingProjectId) return;
            setAuditLoading(true); setShowAuditModal(true); setAuditResult(null);
            try { const result = await callGeminiProjectAudit(projects.find(p => p.id === editingProjectId), tasks.filter(t => t.project_id === editingProjectId)); setAuditResult(result); } catch (err) { alert("åˆ†æå¤±è´¥: " + err.message); setShowAuditModal(false); } finally { setAuditLoading(false); }
          };

          const handleConfirmAuditTasks = async (newTasks) => {
            if (!editingProjectId || !newTasks || newTasks.length === 0) return;
            try { 
              const tasksToInsert = newTasks.map(taskContent => ({ id: crypto.randomUUID(), content: taskContent, project_id: editingProjectId, assigner: '', plan_date: new Date().toISOString(), is_important: false, status: 'active', app_id: PUBLIC_APP_ID, created_at: new Date().toISOString() }));
              if(isOffline) setTasks(prev => [...tasksToInsert, ...prev]);
              else await supabase.from('tasks').insert(tasksToInsert);
              setShowAuditModal(false); 
            } catch (err) { alert("æ·»åŠ ä»»åŠ¡å¤±è´¥: " + err.message); }
          };

          const handleExportData = () => { const data = { projects, tasks, exportDate: new Date().toISOString(), version: '1.0' }; const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `cyber_ox_backup_${new Date().toISOString().split('T')[0]}.json`; a.click(); URL.revokeObjectURL(url); };
          const handleImportData = async (file) => { 
            if (!file) return; const reader = new FileReader(); 
            reader.onload = async (e) => { 
              try { 
                setIsProcessingData(true); const data = JSON.parse(e.target.result); if (!data.projects || !data.tasks) { alert('æ–‡ä»¶æ ¼å¼é”™è¯¯'); setIsProcessingData(false); return; } 
                const projectIdMap = {};
                const newProjects = data.projects.map(p => { const newId = crypto.randomUUID(); projectIdMap[p.id] = newId; return { id: newId, name: p.name, note: p.note || '', status: p.status || 'active', wait_status: p.waitStatus || 'normal', created_at: p.createdAt || new Date().toISOString(), app_id: PUBLIC_APP_ID }; });
                const newTasks = data.tasks.map(t => { return { id: crypto.randomUUID(), content: t.content, status: t.status || 'active', is_important: t.isImportant || false, plan_date: t.plan_date || null, completed_at: t.completedAt || null, project_id: projectIdMap[t.projectId] || null, assigner: t.assigner || '', created_at: t.createdAt || new Date().toISOString(), app_id: PUBLIC_APP_ID }; });
                if (isOffline) { setProjects(prev => [...newProjects, ...prev]); setTasks(prev => [...newTasks, ...prev]); alert(`å¯¼å…¥æˆåŠŸï¼`); }
                else { if (newProjects.length) await supabase.from('projects').insert(newProjects); if (newTasks.length) await supabase.from('tasks').insert(newTasks); alert(`å¯¼å…¥æˆåŠŸï¼`); window.location.reload(); }
                setShowSettings(false); 
              } catch (err) { alert('å¯¼å…¥å¤±è´¥: ' + err.message); } finally { setIsProcessingData(false); } 
            }; reader.readAsText(file); 
          };

          return (
            <div className="min-h-screen pb-20">
              <header className="bg-white/80 backdrop-blur-md sticky top-0 z-30 border-b border-slate-100 shadow-sm px-2 md:px-8 py-2 md:h-16 flex flex-col md:flex-row items-center justify-between gap-3">
                 <div className="flex items-center justify-between w-full md:w-auto gap-4">
                    <div className="flex items-center gap-3">
                        <div className="bg-indigo-600 text-white w-8 h-8 flex items-center justify-center rounded-lg font-bold text-lg shadow-md shadow-indigo-200">ç‰›</div>
                        <h1 className="font-bold text-lg tracking-tight text-slate-800">èµ›åšç‰›é©¬</h1>
                    </div>
                    <div className="flex md:hidden items-center gap-2">
                        <button onClick={handleRunAdvisor} className="p-2 bg-gradient-to-r from-violet-500 to-fuchsia-500 text-white rounded-lg shadow-md"><Sparkles size={18}/></button>
                        <button onClick={() => setShowSettings(true)} className="p-2 text-slate-400 bg-slate-100 rounded-lg relative"><Settings size={18} />{isOffline && <span className="absolute top-1 right-1 w-1.5 h-1.5 bg-amber-500 rounded-full"></span>}</button>
                    </div>
                 </div>

                 <nav className="flex items-center gap-1 bg-slate-100/50 p-1 rounded-lg overflow-x-auto max-w-full no-scrollbar w-full md:w-auto">
                    {[{ id: 'main', label: 'ä¸»é¡µé¢' }, { id: 'history', label: 'å·²æ‰§è¡Œ' }, { id: 'completedProjects', label: 'å·²å®Œæˆ' }, { id: 'weekly', label: 'å‘¨æŠ¥' }].map(tab => (
                      <button key={tab.id} onClick={() => { setCurrentTab(tab.id); setEditingProjectId(null); }} className={`px-4 py-1.5 rounded-md text-sm font-medium transition-all whitespace-nowrap ${currentTab === tab.id && !editingProjectId ? 'bg-white text-indigo-600 shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}>{tab.label}</button>
                    ))}
                 </nav>

                 <div className="hidden md:flex items-center gap-3">
                    <button onClick={handleCreateProject} className="bg-indigo-50 text-indigo-600 hover:bg-indigo-100 px-4 py-2 rounded-lg text-sm font-bold transition-all">åˆ›å»ºé¡¹ç›®</button>
                    <button onClick={() => setShowQuickCreate(true)} className="bg-indigo-600 text-white hover:bg-indigo-700 px-4 py-2 rounded-lg text-sm font-bold shadow-lg shadow-indigo-200 transition-all">å¿«æ·åˆ›å»º</button>
                    <button onClick={handleRunAdvisor} className="bg-gradient-to-r from-violet-500 to-fuchsia-500 text-white hover:opacity-90 px-3 py-2 rounded-lg text-sm font-bold shadow-lg shadow-purple-200 flex items-center gap-1 group transition-all"><Sparkles size={16}/><span className="hidden sm:inline">å†›å¸ˆåˆ†æ</span></button>
                    <button onClick={() => setShowSettings(true)} className="p-2 text-slate-400 hover:text-indigo-600 hover:bg-indigo-50 rounded-full transition-colors relative">
                        <Settings size={20} />
                        {isOffline && <span className="absolute top-1 right-1 w-2 h-2 bg-amber-500 rounded-full"></span>}
                    </button>
                 </div>

                 <div className="md:hidden fixed bottom-6 right-6 z-50 flex flex-col gap-3">
                    <button onClick={handleCreateProject} className="w-12 h-12 bg-white text-indigo-600 rounded-full shadow-xl border border-indigo-100 flex items-center justify-center active:scale-95 transition-transform"><Plus size={24}/></button>
                    <button onClick={() => setShowQuickCreate(true)} className="w-14 h-14 bg-indigo-600 text-white rounded-full shadow-2xl flex items-center justify-center active:scale-95 transition-transform"><Zap size={28}/></button>
                 </div>
              </header>

              <main className="max-w-7xl mx-auto px-2 md:px-8 py-4 md:py-8">
                 {editingProjectId ? (
                   <div className="animate-in slide-in-from-right" key={editingProjectId}>
                      <div className="flex items-center justify-between mb-4">
                        <div className="flex items-center gap-2"><button onClick={()=>setEditingProjectId(null)} className="p-2 hover:bg-white rounded-full transition-colors"><ChevronLeft/></button><h2 className="text-xl font-bold">é¡¹ç›®è¯¦æƒ…</h2></div>
                        <button onClick={handleProjectAudit} className="flex items-center gap-2 px-3 py-1.5 bg-blue-50 text-blue-600 hover:bg-blue-100 rounded-lg text-xs font-bold transition-colors"><Search size={16} /> æŸ¥æ¼</button>
                      </div>
                      <div className="bg-white/80 backdrop-blur-md p-4 rounded-2xl border border-slate-100 shadow-sm mb-4">
                         <input className="text-lg font-bold w-full outline-none mb-2 bg-transparent" defaultValue={projects.find(p=>p.id===editingProjectId)?.name || ''} onBlur={e=>handleUpdateProject(editingProjectId,{name:e.target.value})} placeholder="è¾“å…¥é¡¹ç›®åç§°..." />
                         <textarea className="w-full h-20 text-sm text-slate-600 bg-slate-50/50 rounded-lg p-2 outline-none resize-none" defaultValue={projects.find(p=>p.id===editingProjectId)?.note || ''} onBlur={e=>handleUpdateProject(editingProjectId,{note:e.target.value})} placeholder="æ·»åŠ é¡¹ç›®å¤‡æ³¨..." />
                      </div>
                      <form onSubmit={(e)=>{e.preventDefault(); if(!projectTaskInput.trim()) return; handleCreateTask({content:projectTaskInput, project_id:editingProjectId, assigner:'', plan_date:new Date().toISOString(), is_important:false}); setProjectTaskInput('');}} className="flex gap-2 mb-4">
                         <input className="flex-1 bg-white border border-slate-200 rounded-xl px-3 py-2 outline-none focus:border-indigo-500 shadow-sm text-sm" placeholder="æ·»åŠ æ–°ä»»åŠ¡..." value={projectTaskInput} onChange={e=>setProjectTaskInput(e.target.value)} />
                         <button type="submit" className="bg-indigo-600 text-white px-3 rounded-xl shadow-md"><Plus size={20}/></button>
                      </form>
                      <div className="space-y-2">{tasks.filter(t=>t.project_id===editingProjectId).map(t=><TaskItem key={t.id} task={t} project={projects.find(p=>p.id===editingProjectId)} assigners={assigners} onUpdate={handleUpdateTask} onDeleteRequest={requestDeleteTask} onViewProject={()=>{}} onSmartBreakdown={handleSmartBreakdown} breakdownLoadingId={breakdownLoadingId}/>)}</div>
                   </div>
                 ) : (
                   <>
                     {currentTab === 'main' && <MainTab tasks={tasks} projects={projects} assigners={assigners} onUpdateTask={handleUpdateTask} onDeleteTaskRequest={requestDeleteTask} onViewProject={setEditingProjectId} onCreateProject={handleCreateProject} onDeleteProjectRequest={requestDeleteProject} onUpdateProject={handleUpdateProject} onSmartBreakdown={handleSmartBreakdown} breakdownLoadingId={breakdownLoadingId} />}
                     {currentTab === 'history' && <HistoryTab tasks={tasks} projects={projects} assigners={assigners} onUpdateTask={handleUpdateTask} onDeleteTaskRequest={requestDeleteTask} onViewProject={setEditingProjectId} />}
                     {currentTab === 'completedProjects' && <CompletedProjectsTab projects={projects} onViewProject={setEditingProjectId} onDeleteProjectRequest={requestDeleteProject} onUpdateProject={handleUpdateProject} />}
                     {currentTab === 'weekly' && <WeeklyReportTab tasks={tasks} projects={projects} onUpdateTask={handleUpdateTask} />}
                   </>
                 )}
              </main>

              <QuickCreateModal isOpen={showQuickCreate} onClose={() => setShowQuickCreate(false)} projects={projects} assigners={assigners} onCreate={handleCreateTask} />
              <AnalysisModal isOpen={showAIModal} onClose={() => setShowAIModal(false)} result={analysisResult} isAnalyzing={isAnalyzing} />
              <ProjectAuditModal isOpen={showAuditModal} onClose={() => setShowAuditModal(false)} data={auditResult} isAnalyzing={auditLoading} onAddTasks={handleConfirmAuditTasks} />
              <ConfirmDialog isOpen={confirmData.isOpen} onClose={() => setConfirmData({ ...confirmData, isOpen: false })} onConfirm={executeDelete} title={confirmData.title} message={confirmData.msg} />
              <SettingsModal isOpen={showSettings} onClose={() => setShowSettings(false)} onExport={handleExportData} onImport={handleImportData} isProcessing={isProcessingData} isOffline={isOffline} onSyncToCloud={handleSyncToCloud} />
            </div>
          );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
